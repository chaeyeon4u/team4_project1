<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.webapp.dao.join.ProductDao">

	<resultMap type="productCommon" id="productCommonMap">
		<id property="id" column="id"/>
		<result property="name" column="productName"/>
		<result property="note" column="note"/>
		<result property="brandNo" column="brandNo"/>
	</resultMap>
	
	<resultMap type="productColor" id="productColorMap">
		<id property="id" column="pcolorId"/>
		<result property="img1" column="img1"/>
		<result property="img2" column="img2"/>
		<result property="img3" column="img3"/>
		<result property="colorImg" column="colorImg"/>
		<result property="productCommonId" column="productCommonId"/>
		<result property="colorCode" column="colorCode"/>
		<result property="price" column="price"/>
	</resultMap>
	
	<resultMap type="productStock" id="productStockMap">
		<id property="id" column="id"/>
		<result property="productColorId" column="productColorId"/>
		<result property="sizeCode" column="size_code"/>
		<result property="stock" column="stock"/>
	</resultMap>

	<resultMap type="brand" id="brandMap">
		<id property="no" column="no"/>
		<result property="name" column="brandName"/>
	</resultMap>
	
	<resultMap type="com.mycompany.webapp.vo.join.Product" id="productMap">
		<collection property="productCommon" resultMap="productCommonMap"/>
		<collection property="productColor" resultMap="productColorMap"/>
		<collection property="productStock" resultMap="productStockMap"/>
		<collection property="brand" resultMap="brandMap"/>
	</resultMap>
	
	
	<select id="testRow" resultMap="productMap">
		select brand.name as brandName, product_common.name as productName, img1, price, product_color.id as pcolorId
		from product_common, product_color , brand
		where product_common.id = product_color.product_common_id 
		and brand.no = product_common.brand_no
		order by productName
	</select>
	
	<select id="testDetail" parameterType="String" resultMap="productMap">
		select distinct brand.name as brandName, product_common.name as productName 
				, price, product_color.id as pcolorId, note
				, img1, img2, img3
			from product_common, product_color, brand, product_stock
			where product_common.id = product_color.product_common_id 
			and brand.no = product_common.brand_no
			and product_stock.product_color_id = product_color.id
	        and product_color.id = #{productColorId}
	</select>

	
	<select id="getProductByCategory" parameterType="com.mycompany.webapp.vo.join.CategoryDepthDto" resultMap="productMap">
		
		select rnum, brandName, productName, img1, price, pcolorId
		from (
		select rownum as rnum, brandName, productName, img1, price, pcolorId
		from (
			select
			distinct
			brand.name as brandName, 
			product_common.name as productName, 
			img1, 
			price, 
			product_color.id as pcolorId
			from product_common, product_color , brand, product_category
			where product_common.id = product_color.product_common_id 
			and brand.no = product_common.brand_no
			and product_color.product_common_id = product_category.product_common_id
			and product_category.category_no in (select no from category where 
			depth1_name=#{depth1} 
			<if test="depth2 != null">
			and depth2_name=#{depth2}
			</if>
			<if test="depth3 != null"> 
			and depth3_name=#{depth3}
			</if>
			)
			order by productName
		)
		where rownum &lt;=#{pager.endRowNo}
		)
		where rnum &gt;=#{pager.startRowNo}
	</select>
	
	<select id="countByCategory" parameterType="com.mycompany.webapp.vo.join.CategoryDepthDto" resultType="int">
		select count(*) from(
		select
		distinct
		brand.name as brandName, 
		product_common.name as productName, 
		img1, 
		price, 
		product_color.id as pcolorId
		from product_common, product_color , brand, product_category
		where product_common.id = product_color.product_common_id 
		and brand.no = product_common.brand_no
		and product_color.product_common_id = product_category.product_common_id
		and product_category.category_no in (select no from category where 
		depth1_name=#{depth1} 
		<if test="depth2 != null">
		and depth2_name=#{depth2}
		</if>
		<if test="depth3 != null"> 
		and depth3_name=#{depth3}
		</if>
		)
		order by productName
		)
	</select>
	
</mapper>